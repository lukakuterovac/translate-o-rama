{% extends 'app/base.html' %}

{% block content %}
  <div class="row">
    <div class="col-md-12">
      <h1 class="text-center mt-3 mb-5">Dashboard</h1>
    </div>
  </div>
  
  <h5 class="mb-3">Username: {{ user.username }}</h5>
  <h5 class="mb-3">E-mail: {{ user.email }}</h5>
  <h5 class="mb-3">Token balance: {{ user.userprofile.token_balance }} token(s)</h5>


  <h2 class="text-center mt-5">Jobs</h2>

  <div class="mb-5">
    {% for job in jobs %}
      {% include 'includes/job_card.html' with job=job %}
      <a href="{% url 'app:job_status' job.id %}" class="btn btn-primary col-2">View status</a>
      
      {% if job.is_assigned %}
        <span class="ms-5">Assigned to <a href="{% url 'app:profile' job.assigned_to.bid_user.id %}">{{ job.assigned_to.bid_user.username }}</a></span>
        {% if job.is_completed %}
          {% for dispute in disputes %}
            {% if dispute.status == "Closed" and dispute.job == job %}
              <span class="ms-5">Dispute closed</span>
            {% else %}
              <a href="{% url 'app:dispute_job' job.id %}" class="btn btn-primary ms-5">Dispute</a>
            {% endif %}
            
          {% endfor %}
          <a href="{% url 'app:view_translation' job.id %}" class="btn btn-primary mx-2">View translation</a>
        {% endif %}

      {% else %}

        {% for bid in bids %}
          {% if bid.job == job %}
            <div class="row my-3">
              <h5 class="col-3 d-block"><a href="{% url 'app:profile' bid.bid_user.id %}">{{ bid.bid_user }}</a>: {{ bid.bid }}</h5>
              <form action="{% url 'app:accept_job' bid.id %}" class="col-3" method="post">
                {% csrf_token %}
                <button type="submit" class="btn btn-primary col-3">Accept</button>
              </form>
            </div>
          {% endif %} 
        {% endfor %}
      {% endif %}
      {% empty %}
      <div class="row">
        No jobs posted.
      </div>
    {% endfor %}
  </div>
  
  <h2 class="text-center mt-5 mb-4">Messages</h2>
  
  <div class="mb-4">
    {% for message in messages %}
      <div class="card my-2">
        <div class="card-body m-2">
          <h4>{{ message.from_user.username }}</h4>
          <p>Sent: {{ message.send_date }}</p>
          <p>{{ message.text }}</p>
          <a href="{% url 'app:profile' message.from_user.id %}" class="card-link">{{ message.from_user }}'s profile</a>
        </div>
      </div>
    {% empty %}
      <div class="row">
        No messages.
      </div>
    {% endfor %}
  </div>


  {% if user.userprofile.is_translator %}
    <h2 class="text-center mt-5 mb-4">Submitted bids</h2>
    {% for bid in translator_bids %}
      {% include 'includes/bid_form.html' with job_bid=bid %}
    {% endfor %}

    <h2 class="text-center mt-5 mb-4">Assigned jobs</h2>
    {% for a_job in assigned_jobs %}
      {% include 'includes/job_card.html' with job=a_job %}
      <form action="{% url 'app:complete_job' user.id a_job.id %}">
        {% csrf_token %}
        <div class="row mt-4 text-center mb-5">
            <div clss="col-md-8 ms-2">
                <input type="submit" value="Complete" class="custom-btn btn px-4 py-2">
            </div>
        </div>
    </form>
    {% endfor %}

    <!--Jobs that he ended-->
    <h2 class="text-center mt-5 mb-4">Completed jobs</h2>
    {% for c_job in completed_jobs %}
      {% include 'includes/job_card.html' with job=c_job %}
    {% endfor %}

  {% endif %}
{% endblock content %}